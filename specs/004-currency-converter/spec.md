# Feature Specification: 台幣與外幣匯率計算器

**Feature Branch**: `004-currency-converter`  
**Created**: 2025年11月1日  
**Status**: Draft  
**Input**: 台幣與外幣匯率計算器 - 開發規格書

## Clarifications

### Session 2025-11-01

- Q: 本地匯率資料保留政策？ → A: 僅保留最新一份匯率資料，每次更新覆蓋舊資料
- Q: 首次載入時無本地資料的處理策略？ → A: 自動觸發匯率更新，載入最新資料後才顯示計算介面
- Q: 系統錯誤日誌記錄範圍？ → A: 記錄錯誤與警告層級（API 失敗、驗證錯誤、資料過期警告）
- Q: 多使用者同時更新匯率時的處理策略？ → A: 允許並行更新，但只保留最後完成的結果（覆蓋寫入）
- Q: 系統效能目標中的「每小時1000次請求」範圍？ → A: 系統總負載量（所有使用者加總每小時1000次）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 台幣轉外幣匯率計算 (Priority: P1)

作為使用者，我想要輸入台幣金額並選擇目標外幣，系統能立即顯示可兌換的外幣金額,讓我了解目前的兌換價值。

**Why this priority**: 這是核心功能，提供最基本的匯率計算服務，是整個系統的價值基礎。

**Independent Test**: 使用者輸入「1000」台幣，選擇「美元」，系統顯示對應的美元金額（例如：31.25 USD），此功能可獨立測試並交付價值。

**Acceptance Scenarios**:

1. **Given** 使用者在台幣金額欄位輸入「10000」，**When** 選擇目標貨幣為「美元 (USD)」並點擊計算，**Then** 系統顯示對應的美元金額，使用現金賣出匯率計算，結果保留小數點後六位
2. **Given** 使用者在台幣金額欄位輸入「5000」，**When** 選擇目標貨幣為「日圓 (JPY)」並點擊計算，**Then** 系統顯示對應的日圓金額
3. **Given** 使用者在台幣金額欄位輸入「0」或負數，**When** 點擊計算，**Then** 系統顯示錯誤訊息「金額必須為正數」

---

### User Story 2 - 外幣轉台幣匯率計算 (Priority: P1)

作為使用者，我想要輸入外幣金額並選擇來源外幣，系統能立即顯示可兌換的台幣金額，讓我了解需要準備多少台幣。

**Why this priority**: 與台幣轉外幣同等重要，提供雙向計算能力，滿足不同場景需求。

**Independent Test**: 使用者輸入「100」美元，系統顯示對應的台幣金額（例如：3200 TWD），此功能可獨立測試並交付價值。

**Acceptance Scenarios**:

1. **Given** 使用者在外幣金額欄位輸入「100」，**When** 選擇來源貨幣為「美元 (USD)」並點擊計算，**Then** 系統顯示對應的台幣金額，使用現金買入匯率計算
2. **Given** 使用者在外幣金額欄位輸入「10000」，**When** 選擇來源貨幣為「日圓 (JPY)」並點擊計算，**Then** 系統顯示對應的台幣金額
3. **Given** 使用者選擇的來源貨幣與目標貨幣相同，**When** 點擊計算，**Then** 系統顯示錯誤訊息「來源與目標貨幣不能相同」

---

### User Story 3 - 即時匯率更新 (Priority: P2)

作為使用者，我想要看到匯率資料的最後更新時間，並能手動觸發更新，確保使用最新的匯率資料進行計算。

**Why this priority**: 確保資料準確性和時效性，提升使用者對系統的信任度。

**Independent Test**: 使用者點擊「更新匯率」按鈕，系統從台灣銀行 API 取得最新匯率並顯示更新時間，此功能可獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者進入匯率計算器頁面，**When** 頁面載入完成，**Then** 系統顯示當前日期（含星期）及匯率資料最後更新時間；若無本地資料則自動觸發更新
2. **Given** 使用者點擊「更新匯率」按鈕，**When** 系統成功從台灣銀行 CSV API 取得資料，**Then** 顯示載入動畫，更新完成後顯示新的更新時間
3. **Given** 匯率資料超過24小時未更新，**When** 使用者進入頁面，**Then** 系統顯示警告訊息「⚠️ 注意：匯率資料已超過24小時未更新，建議點擊『更新匯率』取得最新資料」
4. **Given** 使用者點擊「更新匯率」按鈕，**When** 台灣銀行 API 無法連線或回應錯誤，**Then** 系統顯示錯誤訊息「⚠️ 無法取得最新匯率資料，目前使用本地快取資料，請稍後再試」並繼續使用快取資料

---

### User Story 4 - 多貨幣支援 (Priority: P2)

作為使用者，我想要從多種主要外幣中選擇，進行匯率計算，滿足不同國家旅遊或交易需求。

**Why this priority**: 擴展系統實用性，涵蓋主要國際貨幣，滿足大部分使用場景。

**Independent Test**: 使用者可以選擇美元、日圓、人民幣、歐元、英鎊、港幣、澳幣等七種主要貨幣進行計算，每種貨幣都能正常運作。

**Acceptance Scenarios**:

1. **Given** 使用者查看貨幣選單，**When** 展開下拉選單，**Then** 系統顯示：美元 (USD)、日圓 (JPY)、人民幣 (CNY)、歐元 (EUR)、英鎊 (GBP)、港幣 (HKD)、澳幣 (AUD)
2. **Given** 使用者選擇任一支援貨幣，**When** 輸入金額並計算，**Then** 系統使用對應貨幣的匯率進行計算

---

### User Story 5 - 響應式介面與即時回饋 (Priority: P3)

作為使用者，我想要在桌面和手機上都能流暢使用匯率計算器，並在輸入時獲得即時的格式提示和回饋。

**Why this priority**: 提升使用者體驗，讓系統更易用和友善，但不影響核心功能。

**Independent Test**: 在不同裝置（桌面、平板、手機）上開啟系統，介面自動調整並保持可用性；輸入無效資料時即時顯示提示。

**Acceptance Scenarios**:

1. **Given** 使用者在手機瀏覽器開啟匯率計算器，**When** 頁面載入完成，**Then** 介面自動調整為適合手機螢幕的佈局，所有按鈕和輸入框易於操作
2. **Given** 使用者在桌面瀏覽器開啟匯率計算器，**When** 頁面載入完成，**Then** 介面以桌面優化佈局呈現
3. **Given** 使用者在金額欄位輸入非數字字元，**When** 離開輸入框，**Then** 系統即時顯示格式提示「請輸入有效的數字」
4. **Given** 系統正在更新匯率資料，**When** 更新進行中，**Then** 顯示載入動畫並停用計算按鈕，避免使用舊資料計算

---

### Edge Cases

- 當使用者輸入極大金額（超過系統數值處理上限）時，系統如何處理？
  - 系統應捕捉計算溢位例外，顯示錯誤訊息「金額超過系統處理範圍，請輸入較小的金額」
  
- 當台灣銀行 CSV API 格式變更（欄位順序或名稱改變）時，系統如何處理？
  - 系統應驗證 CSV 欄位完整性，若偵測到格式異常，顯示錯誤訊息並使用本地快取資料，同時記錄錯誤日誌供管理員檢查
  
- 當本地快取資料不存在且 API 無法連線時，系統如何處理？
  - 系統應顯示明確錯誤訊息「無法載入匯率資料，請檢查網路連線後重試」，並停用計算功能直到資料可用；首次載入時若無本地資料，系統會自動觸發匯率更新
  
- 當使用者快速連續點擊「更新匯率」按鈕時，系統如何避免重複請求？
  - 系統應在更新進行中停用按鈕，並設定請求間隔限制（如30秒內不重複請求）
  
- 當 CSV 資料中某個貨幣的匯率欄位為空值或無效時，系統如何處理？
  - 系統應跳過該筆無效資料，並在日誌中記錄，不影響其他貨幣的正常運作

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須提供台幣轉外幣計算功能，使用者輸入台幣金額並選擇目標外幣，系統顯示對應外幣金額
- **FR-002**: 系統必須提供外幣轉台幣計算功能，使用者輸入外幣金額並選擇來源外幣，系統顯示對應台幣金額
- **FR-003**: 系統必須支援七種主要外幣：美元 (USD)、日圓 (JPY)、人民幣 (CNY)、歐元 (EUR)、英鎊 (GBP)、港幣 (HKD)、澳幣 (AUD)
- **FR-004**: 系統必須從台灣銀行官方 CSV API (<https://rate.bot.com.tw/xrt/flcsv/0/day>) 取得即時匯率資料
- **FR-005**: 系統必須將取得的 CSV 資料解析並轉換為結構化格式儲存於本地，以支援離線查詢；每次更新時覆蓋舊資料，僅保留最新一份匯率資料
- **FR-006**: 系統必須使用「現金賣出匯率」計算台幣轉外幣
- **FR-007**: 系統必須使用「現金買入匯率」計算外幣轉台幣
- **FR-008**: 系統必須將計算結果保留到小數點後第六位，使用四捨五入方式處理
- **FR-009**: 系統必須確保金額計算精確，避免浮點數精度誤差
- **FR-010**: 系統必須顯示當前日期（含星期）及匯率資料最後更新時間
- **FR-011**: 系統必須提供手動更新匯率功能，使用者點擊按鈕後從 API 取得最新資料
- **FR-012**: 系統必須在匯率資料超過24小時未更新時，顯示警告訊息提醒使用者
- **FR-013**: 系統必須快取匯率資料30分鐘，避免過於頻繁的 API 請求
- **FR-014**: 系統必須驗證使用者輸入的金額為正數，拒絕零值或負數
- **FR-015**: 系統必須驗證使用者輸入的金額為有效數字格式
- **FR-016**: 系統必須驗證來源貨幣與目標貨幣不能相同
- **FR-017**: 系統必須驗證 CSV 資料完整性，確保必要欄位（貨幣代碼、買入匯率、賣出匯率）存在且格式正確；當多使用者同時更新時，允許並行執行，最後完成的更新結果將覆蓋先前資料
- **FR-018**: 系統必須提供響應式設計，支援桌面、平板、手機等不同裝置
- **FR-019**: 系統必須在使用者輸入無效資料時，即時顯示格式提示
- **FR-020**: 系統必須在更新匯率時顯示載入動畫，並停用計算功能直到更新完成
- **FR-021**: 系統必須處理網路連線失敗情境，顯示友善錯誤訊息並使用本地快取資料
- **FR-022**: 系統必須處理 CSV API 回應錯誤或格式變更，顯示錯誤訊息並使用本地快取資料
- **FR-023**: 系統必須處理計算溢位例外，顯示錯誤訊息當金額超過系統處理範圍
- **FR-024**: 系統必須統一使用台灣時區 (UTC+8) 處理所有日期時間
- **FR-025**: 系統必須以中文格式顯示日期（如「2025年11月1日 (五)」）
- **FR-026**: 系統必須以24小時制顯示時間（如「14:30:00」）
- **FR-027**: 系統必須在頁面底部顯示免責聲明，提醒使用者匯率僅供參考
- **FR-028**: 系統必須確保匯率更新過程不會阻塞使用者介面操作
- **FR-029**: 系統必須設定適當的 API 請求逾時時間（建議15秒）
- **FR-030**: 所有錯誤訊息必須使用中文，包含具體錯誤原因及建議解決方案
- **FR-031**: 系統必須記錄錯誤與警告層級的日誌，包含 API 失敗、驗證錯誤、資料過期警告、CSV 格式異常等事件，以支援問題診斷

### Key Entities

- **ExchangeRate（匯率資料）**: 代表特定貨幣的匯率資訊，包含貨幣代碼、貨幣名稱、現金買入匯率、現金賣出匯率、最後更新時間
- **Currency（貨幣）**: 代表支援的貨幣類型，包含貨幣代碼（如 USD、JPY）、貨幣名稱（如美元、日圓）
- **CalculationRequest（計算請求）**: 代表使用者的計算請求，包含來源金額、來源貨幣、目標貨幣、計算方向（台幣轉外幣或外幣轉台幣）
- **CalculationResult（計算結果）**: 代表計算後的結果，包含轉換後金額、使用的匯率、計算時間

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者能在3秒內完成一次匯率計算（從輸入到顯示結果）
- **SC-002**: 匯率資料更新能在15秒內完成（從點擊按鈕到資料更新完成）
- **SC-003**: 系統在台灣銀行 API 無法連線時，能在2秒內切換至本地快取資料並顯示錯誤提醒
- **SC-004**: 計算結果精確度達小數點後第六位，誤差不超過 0.000001
- **SC-005**: 系統能在不同裝置（桌面、平板、手機）上正常運作，介面自動適應螢幕尺寸
- **SC-006**: 90%的使用者能在首次使用時成功完成匯率計算，無需額外說明
- **SC-007**: 系統能正確處理100%的無效輸入情境（負數、非數字、空值等），並顯示友善錯誤訊息
- **SC-008**: 快取機制能減少50%以上的 API 請求次數（30分鐘內重複查詢使用快取）
- **SC-009**: 系統能處理每小時1000次計算請求（系統總負載量）而不出現效能下降
- **SC-010**: 匯率資料時效性檢查準確率達100%，超過24小時未更新時必定顯示警告
