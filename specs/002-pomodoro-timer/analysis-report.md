# 規格一致性分析報告 - 番茄工作法計時器

**功能**: 番茄工作法計時器  
**分支**: 002-pomodoro-timer  
**分析日期**: 2025-10-31  
**分析工具**: /speckit.analyze  
**分析範圍**: spec.md, plan.md, tasks.md, constitution.md

---

## 執行摘要

對番茄工作法計時器功能規格進行跨文件一致性分析，檢查 25 個功能需求（FR-001 至 FR-025）、5 個使用者故事（US1-US5）、119 個實作任務（T001-T119）以及憲章原則的對齊狀況。

**核心發現**:

- ✅ 功能需求覆蓋率：**100%** (25/25 個需求皆有對應任務)
- ⚠️ 發現 **11 個問題**，包含 **3 個 CRITICAL 憲章違規**
- ⚠️ 測試策略與憲章 TDD 原則存在根本性衝突
- ✅ 無重大需求遺漏或重複定義

---

## 問題清單

### CRITICAL 級別（必須解決）

| ID | 類別 | 位置 | 摘要 | 建議修正 |
|----|------|------|------|----------|
| **F-001** | 憲章違規 | tasks.md Phase 2,3,5,6,8 | **測試任務違反 TDD 工作流程**：9 個測試任務標記為 ⚠️ OPTIONAL（T013-T015, T040-T041, T073, T088, T113-T115），且放置在實作程式碼之後，違反憲章第 II 條「測試必須先於實作程式碼提交」。 | 選項 A（推薦）：移除所有 ⚠️ 標記，將測試任務重新排序至對應實作任務之前，恢復 TDD 流程。選項 B：更新憲章第 II 條，明確允許「環境限制情境下可延後執行整合/UI 測試，但單元測試必須先行」，並在 tasks.md 頂部加入例外說明。 |
| **F-002** | 憲章違規 | tasks.md T115 | **測試覆蓋率無法驗證**：T115「產生覆蓋率報告並驗證達成 80% 目標」標記為 ⚠️ OPTIONAL，導致憲章第 II 條「商業邏輯最低 80% 程式碼覆蓋率」要求無法驗證。 | 將 T115 改為必要任務（移除 ⚠️），並在 T115 的 Acceptance Criteria 中明確指定：「服務層覆蓋率必須 ≥80%，JavaScript 核心邏輯覆蓋率 ≥70%」。如因環境限制無法執行，需在 PR 說明中提供手動測試證據。 |
| **F-003** | 憲章違規 | tasks.md Phase 8 | **效能要求缺少驗證任務**：憲章第 IV 條要求「API 回應時間 GET <200ms, POST <500ms」，spec.md SC-005 要求「頁面載入和計時器回應時間低於 500 毫秒」，但 T107-T108 僅驗證頁面載入時間，FR-013到FR-018 涉及的 6 個 API 端點（統計資料讀寫、設定讀寫）無回應時間測試。 | 新增 T108a：「建立效能測試 - 使用 BenchmarkDotNet 測試 PomodoroDataService 的 SaveStatisticsAsync、LoadStatisticsAsync、SaveSettingsAsync、LoadSettingsAsync 方法，驗證回應時間 <100ms（p95）」。 |

---

### HIGH 級別（建議優先處理）

| ID | 類別 | 位置 | 摘要 | 建議修正 |
|----|------|------|------|----------|
| **F-004** | 模糊需求 | spec.md SC-002 | **時間準確度測量方式未定義**：規格要求「計時器的時間準確度誤差不超過 1 秒」，但未說明如何測量（測試時長多久？如何驗證？）。 | 在 spec.md SC-002 補充測試方法：「測試方式：模擬計時器執行 30 分鐘，使用 setInterval 每秒驗證一次，累計誤差不得超過 ±1 秒」。在 T038 測試任務中引用此測試方法。 |
| **F-005** | 覆蓋缺口 | FR-023, tasks.md T103 | **資料損壞恢復無對應測試**：FR-023 要求「系統必須在資料讀取失敗時，自動恢復為預設設定並顯示通知訊息」，T103 有實作程式碼，但 T013-T015 測試任務中未包含此錯誤處理場景。 | 在 T014（PomodoroDataServiceTests）的描述中明確加入：「測試場景應包含：損壞的 JSON 格式、權限錯誤、檔案不存在，驗證回傳預設值並記錄錯誤」。 |
| **F-006** | 術語不一致 | spec.md FR-010, tasks.md T026-T027 | **"橫幅" vs "Toast"**：spec.md FR-010 稱為「頁面內橫幅通知訊息」，tasks.md T026-T027 使用「Bootstrap Toast 通知容器」，同一功能使用不同術語可能造成混淆。 | 選項 A：統一改為「Toast 通知」（技術實作術語）。選項 B：spec.md 保留「橫幅通知」（使用者視角），但在 FR-010 末尾加註：「實作使用 Bootstrap Toast 元件」。 |

---

### MEDIUM 級別（視情況處理）

| ID | 類別 | 位置 | 摘要 | 建議修正 |
|----|------|------|------|----------|
| **F-007** | 覆蓋缺口 | spec.md SC-009 | **非功能需求覆蓋不足**：SC-009 要求「使用者的平均任務完成率提升至少 30%」，這是長期行為指標，但無任務定義如何測量或追蹤。 | 選項 A：將 SC-009 移至「Out of Scope」，說明這是產品上線後的長期追蹤指標，需使用者研究。選項 B：保留 SC-009，但在 spec.md 假設中補充：「任務完成率提升需透過使用者訪談或外部工具（如 Google Analytics）追蹤，不在本功能實作範圍內」。 |
| **F-008** | 實體定義不完整 | spec.md 關鍵實體, data-model.md | **Timer State 儲存位置模糊**：spec.md 列出 Timer State 實體（包含開始時間戳），但未明確說明只存於 localStorage 不持久化到伺服器。tasks.md T031-T034 實作正確，但 spec 不清楚可能誤導。 | 在 spec.md 關鍵實體章節的 Timer State 條目末尾補充：「（註：此狀態僅存於瀏覽器 localStorage，不寫入伺服器 JSON 檔案，用於避免多視窗衝突和計時器恢復）」。 |
| **F-009** | 任務順序邏輯問題 | tasks.md T078, T106 | **快取驗證時機不當**：T078 [US4] 實作快取邏輯（「儲存至 JSON、更新 IMemoryCache」），但 T106 [Phase 8] 才驗證快取，間隔 28 個任務，若中間發現快取問題需大幅回溯。 | 建議將 T106 移至 Phase 6（US4 完成後），並重新編號為 T089a，放在 T089 之後，確保 US4 功能驗證完整性。 |

---

### LOW 級別（可選修正）

| ID | 類別 | 位置 | 摘要 | 建議修正 |
|----|------|------|------|----------|
| **F-010** | 值範圍不一致 | spec.md FR-010, tasks.md T027 | **通知持續時間不一致**：spec.md FR-010 給定範圍「3-5秒後自動消失」，tasks.md T027 選定單一數值「4 秒自動消失」，但未說明選擇 4 秒的理由。 | 選項 A：spec.md 直接改為單一數值「4 秒後自動消失」。選項 B：tasks.md T027 補充註解：「選用 4 秒（規格範圍 3-5 秒的中值），平衡閱讀時間與介面清爽度」。 |
| **F-011** | 文件語氣不一致 | constitution.md, tasks.md T110 | **XML 註解語言要求語氣不同**：constitution.md 原則 V 使用「建議使用繁體中文」（非強制），tasks.md T110 使用「檢查所有 C# 檔案包含 XML 文件註解（繁體中文）」（強制語氣）。 | 將 T110 描述改為：「檢查所有 C# 公開 API 包含 XML 文件註解（建議繁體中文，接受英文），確保 IDE 工具提示完整」，對齊憲章語氣。 |

---

## 需求覆蓋率矩陣

| 需求 ID | 需求摘要 | 對應任務 | 覆蓋狀態 | 備註 |
|---------|----------|----------|----------|------|
| FR-001 | 獨立計時器頁面 | T011 | ✅ | 頁面建立 |
| FR-002 | 工作時段倒數（25 分） | T018, T020 | ✅ | 模型 + 邏輯 |
| FR-003 | 休息時段倒數（5 分） | T019, T020 | ✅ | 模型 + 邏輯 |
| FR-004 | 自動切換時段 | T022 | ✅ | 狀態機邏輯 |
| FR-005 | 完成番茄鐘計數 | T023, T059 | ✅ | UI + 統計 |
| FR-006 | 開始按鈕 | T025, T029 | ✅ | HTML + JS |
| FR-007 | 暫停功能 | T042, T050 | ✅ | 控制邏輯 |
| FR-008 | 繼續功能 | T043, T051 | ✅ | 控制邏輯 |
| FR-009 | 重置功能 | T044, T052 | ✅ | 控制邏輯 |
| FR-010 | 通知訊息 | T026, T027 | ✅ | Toast 容器 + JS |
| FR-011 | 顯示時段類型 | T024 | ✅ | UI 元素 |
| FR-012 | MM:SS 格式 | T024, T028 | ✅ | UI + 格式化函式 |
| FR-013 | 記錄番茄鐘計數 | T062, T063, T064 | ✅ | 統計邏輯 |
| FR-014 | 持久化統計 | T056, T057 | ✅ | JSON 服務 |
| FR-015 | 跨日界重置 | T057 | ✅ | 日期比對邏輯 |
| FR-016 | 自訂工作時長 | T080, T081, T085 | ✅ | 設定表單 + 驗證 |
| FR-017 | 自訂休息時長 | T080, T081, T085 | ✅ | 設定表單 + 驗證 |
| FR-018 | 持久化設定 | T078 | ✅ | JSON 服務 + 快取 |
| FR-019 | 圓形進度環 | T091, T092, T093 | ✅ | SVG 繪製 |
| FR-020 | 進度同步更新 | T094 | ✅ | JS 定時器 |
| FR-021 | 離線時間準確性 | T020, T032 | ✅ | 伺服器時間 + localStorage |
| FR-022 | 輸入驗證 | T077, T081, T085 | ✅ | 驗證服務 + 前端 |
| FR-023 | 資料恢復 | T103 | ⚠️ | 實作存在，測試不足（見 F-005） |
| FR-024 | 按鈕狀態管理 | T045, T047-T049 | ✅ | 狀態機 |
| FR-025 | 多視窗偵測 | T066-T072 | ✅ | localStorage 衝突偵測 |

**總計**: 25/25 個需求有對應任務，覆蓋率 **100%**

---

## 憲章原則對齊檢查

| 憲章原則 | 對齊狀態 | 發現的問題 |
|---------|----------|-----------|
| **I. 程式碼品質** | ⚠️ 部分對齊 | F-011（XML 註解語氣不一致），但不影響實際品質 |
| **II. 測試標準** | ❌ **違規** | F-001（測試未先行）、F-002（覆蓋率無法驗證） - **CRITICAL** |
| **III. UX 一致性** | ✅ 完全對齊 | plan.md 確認使用現有 _Layout.cshtml，無違規 |
| **IV. 效能要求** | ⚠️ 部分對齊 | F-003（API 回應時間缺少驗證）- **CRITICAL** |
| **V. 文件語言** | ✅ 完全對齊 | 所有文件、UI 文字、XML 註解皆使用繁體中文 |

**重要警告**: 憲章第 II 條「測試標準」存在兩處 CRITICAL 違規，必須在開始實作前解決（見 F-001, F-002）。

---

## 使用者故事任務分佈

| 使用者故事 | 優先級 | 任務範圍 | 任務數量 | 覆蓋狀態 |
|-----------|--------|---------|---------|---------|
| US1 - 基本計時循環 | P1 | T016-T041 | 26 | ✅ 完整（包含 ⚠️ T040-T041 測試） |
| US2 - 暫停/繼續/重置 | P2 | T042-T054 | 13 | ✅ 完整 |
| US3 - 統計追蹤 | P2 | T055-T075 | 21 | ✅ 完整（包含 ⚠️ T073 測試） |
| US4 - 自訂時長 | P3 | T076-T090 | 15 | ✅ 完整（包含 ⚠️ T088 測試） |
| US5 - 進度環 | P3 | T091-T098 | 8 | ✅ 完整 |
| 基礎建置 | - | T001-T015 | 15 | ✅ 完整（包含 ⚠️ T013-T015 測試） |
| 品質保證 | - | T099-T119 | 21 | ✅ 完整（包含 ⚠️ T113-T115 測試） |

**總計**: 119 個任務，5 個使用者故事皆有完整覆蓋

---

## 未對應任務分析

以下任務無直接對應的功能需求（FR-XXX），屬於工程基礎建設或品質保證：

**合理的無對應任務**（基礎建設）:

- T001-T005（Phase 1: Setup）- 目錄建立、導覽連結
- T006-T012（Phase 2: Foundational Models/Services）- 模型類別、服務註冊
- T099-T119（Phase 8: Polish）- 文件、Markdown 格式、驗收測試、部署

**結論**: 所有未對應任務皆屬合理的工程支援工作，無冗餘任務。

---

## 統計摘要

| 指標 | 數值 |
|------|------|
| 總功能需求數 | 25 |
| 總成功標準數 | 9 |
| 總使用者故事數 | 5 |
| 總任務數 | 119 |
| 需求覆蓋率 | 100% (25/25) |
| 標記為 ⚠️ OPTIONAL 的測試任務 | 9 |
| 發現問題總數 | 11 |
| - CRITICAL | 3 |
| - HIGH | 3 |
| - MEDIUM | 3 |
| - LOW | 2 |
| 憲章違規項目 | 3 (F-001, F-002, F-003) |

---

## 建議行動

### 立即執行（開始實作前必須解決）

1. **[F-001] 解決測試策略與憲章衝突**：
   - **推薦方案**: 將 9 個 ⚠️ 測試任務改為必要任務，移除標記，並重新排序至實作任務之前
   - **預計影響**: 需重新排序 tasks.md 中約 20 個任務
   - **驗收標準**: 所有測試任務（T013-T015, T040-T041等）移至對應實作任務之前，TDD 流程恢復

2. **[F-002] 確保覆蓋率驗證可執行**：
   - 移除 T115 的 ⚠️ 標記，並在描述中加入明確的覆蓋率門檻（服務層 ≥80%）
   - 若環境限制無法執行自動化覆蓋率報告，需在 PR 中提供手動測試證據

3. **[F-003] 新增 API 效能測試任務**：
   - 在 Phase 8 插入 T108a，使用 BenchmarkDotNet 驗證 PomodoroDataService 方法回應時間 <100ms

### 短期改進（本週內處理）

1. **[F-004] 明確化時間準確度測試方法**：在 spec.md SC-002 補充測試步驟
2. **[F-005] 強化資料損壞測試**：在 T014 測試任務中加入錯誤處理場景
3. **[F-006] 統一術語**：決定使用「Toast 通知」或「橫幅通知」，全文統一

### 中期優化（下次迭代考慮）

1. **[F-007] 釐清 SC-009 範圍**：將任務完成率提升移至 Out of Scope 或補充追蹤方法
2. **[F-008] 補充 Timer State 說明**：在 spec.md 關鍵實體中註明儲存位置
3. **[F-009] 調整任務順序**：將 T106 移至 T089 之後，縮短驗證回饋週期

### 可選修正（低優先級）

1. **[F-010] 明確通知持續時間**：spec 改為單一數值或 tasks 補充選擇理由
2. **[F-011] 對齊 XML 註解語氣**：T110 改為「建議繁體中文」

---

## 附錄：檢測方法

本報告使用以下方法進行一致性分析：

1. **需求清單建立**：從 spec.md 提取 25 個 FR、5 個 US、9 個 SC
2. **任務清單提取**：從 tasks.md 提取 119 個任務及 [US1]-[US5] 標記
3. **覆蓋率對應**：使用語義匹配，將每個 FR 對應至執行該需求的任務
4. **憲章對齊檢查**：比對 constitution.md 的 5 個核心原則與 tasks.md 實作計畫
5. **重複與模糊檢測**：識別近似需求（語義相似度 >85%）及缺乏量化指標的需求
6. **術語一致性分析**：比對 spec.md 與 tasks.md 中關鍵術語的使用

**工具版本**: speckit.analyze v1.0 (2025-10-31)

---

## 結論

番茄工作法計時器的規格文件在需求覆蓋率和使用者故事分佈上表現優異（100% 覆蓋），但存在 **3 個 CRITICAL 級別的憲章違規問題**，主要集中在測試策略與 TDD 原則的衝突。建議在開始實作前優先解決 F-001、F-002、F-003 三個問題，確保專案符合憲章的測試標準和效能要求。其餘 8 個問題可在實作過程中逐步改進，不影響主要功能開發。

**Ready for Implementation**: ❌ **NO** - 必須先解決 3 個 CRITICAL 問題才能開始 Phase 3 實作。

---

**報告生成時間**: 2025-10-31  
**分析工具**: GitHub Copilot `/speckit.analyze`  
**報告版本**: 1.0
